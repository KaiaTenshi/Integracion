<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rival Más Débil — Evento Competitivo</title>
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#141c2f;
      --panel-2:#0f172a;
      --ink:#e6edf3;
      --muted:#9fb2c8;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --primary:#3b82f6;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --radius-sm:10px;
      --maxw:1040px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background: radial-gradient(1200px 600px at 80% -50%, #1f2a48, transparent 60%), var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app{
      max-width:var(--maxw);
      margin-inline:auto;
      padding:clamp(12px,2.5vw,24px);
      display:grid;
      gap:clamp(12px,2vw,20px);
    }

    header{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr auto;
      align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%), var(--panel-2);
      border:1px solid rgba(255,255,255,.08);
      padding:16px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    .title{
      display:flex; gap:12px; align-items:center; min-width:0;
    }
    .title h1{
      margin:0;
      font-size:clamp(18px, 3.5vw, 24px);
      line-height:1.15;
      font-weight:700;
      letter-spacing:.2px;
    }
    .status-chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }

    .grid{
      display:grid;
      gap:clamp(12px,2vw,16px);
    }
    @media (min-width: 960px){
      .grid{ grid-template-columns: 1.1fr .9fr; align-items:start; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%), var(--panel);
      border:1px solid rgba(255,255,255,.09);
      border-radius:var(--radius);
      padding:clamp(14px,2.2vw,18px);
      box-shadow:var(--shadow);
    }

    .section-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .section-title h2{
      margin:0;
      font-size:clamp(16px,3vw,20px);
      letter-spacing:.2px;
    }
    .subtle{color:var(--muted); font-size:13px}

    .controls{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    button, .btn{
      appearance:none; border:0; cursor:pointer;
      padding:12px 14px; border-radius:12px;
      background:#1f2a48; color:var(--ink);
      border:1px solid rgba(255,255,255,.1);
      transition:.2s transform, .2s background, .2s border-color, .2s opacity;
      font-weight:600; letter-spacing:.2px;
      min-height:44px;
      touch-action:manipulation;
    }
    button:disabled{opacity:.5; cursor:not-allowed}
    button.primary{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--primary); color:white; border-color:rgba(0,0,0,.0)}
    button.success{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--accent); color:#0a1a0a;}
    button.warn{background:linear-gradient(180deg, rgba(0,0,0,.15), transparent 50%), #25324d; border-color:#3b4a6b; color:#cfe0ff}
    button.danger{background:linear-gradient(180deg, rgba(255,255,255,.08), transparent 50%), var(--danger); color:white}

    /* Entrada de nombre */
    .join-row{display:flex; gap:8px; flex-wrap:wrap}
    .join-row input{
      flex:1 1 220px; min-width:160px;
      background:#0c1326; color:var(--ink);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:12px 14px;
      min-height:44px;
      outline:none;
    }
    .tag{ font-size:12px; padding:6px 8px; border-radius:999px; background:#0c1326; border:1px solid rgba(255,255,255,.12); color:#a5b4fc }
    .tag.mod{ color:#22d3ee; }
    .tag.out{ color:#fca5a5; }
    .me{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }

    /* Lista de participantes */
    .list{
      display:grid; gap:8px;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .player{
      background: #0c1326; border:1px solid rgba(255,255,255,.08); border-radius:12px;
      padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .player .name{ font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .badges{display:flex; gap:6px; align-items:center; flex-wrap:wrap}

    /* Progreso grupal */
    .progress-wrap{ display:grid; gap:8px }
    .progress-bar{
      --v:0%;
      height:16px; border-radius:999px; background:#0c1326; border:1px solid rgba(255,255,255,.12); overflow:hidden;
      position:relative;
    }
    .progress-fill{
      position:absolute; inset:0;
      width:var(--v);
      background: linear-gradient(90deg, #22c55e, #10b981);
      box-shadow: inset 0 0 16px rgba(0,0,0,.25);
      transition: width .25s ease;
    }
    .prog-ctrls{ display:flex; gap:8px; flex-wrap:wrap }

    /* Modal de votación */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; backdrop-filter:saturate(120%) blur(10px); z-index:50;
      padding:20px;
      background: color-mix(in srgb, #0b1020 85%, transparent);
    }
    .modal.show{ display:grid }
    .modal .box{
      width:min(680px, 100%); background:var(--panel); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px; box-shadow:var(--shadow);
      display:grid; gap:12px;
    }
    .cand-list{ display:grid; gap:8px; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); }
    .cand{
      background:#0c1326; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; display:grid; gap:6px;
    }
    .cand button{ width:100% }
    .hl{ color:#c7d2fe; }

    /* Toast */
    .toast{
      position: fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:60;
      background:#101a33; color:#e5edff; border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:10px; box-shadow:var(--shadow);
      display:none;
    }
    .toast.show{ display:block }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div style="width:12px;height:12px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.25);" id="conn-dot"></div>
        <h1>Rival Más Débil</h1>
      </div>
      <div class="me">
        <span class="status-chip" id="roleChip">Conectando a Firebase…</span>
        <span class="status-chip" id="phaseChip">Fase: —</span>
      </div>
    </header>

    <div class="grid">
      <!-- Lado izquierdo: Lobby y Participantes -->
      <section class="card">
        <div class="section-title">
          <h2>Lobby & Participantes</h2>
          <span class="subtle">Máx. 1 moderador + 10 participantes</span>
        </div>

        <div class="join-row" style="margin-bottom:10px">
          <input id="displayName" type="text" placeholder="Tu nombre (requerido para unirte)" autocomplete="name" />
          <div class="controls">
            <button id="btnJoin" class="primary">Unirme</button>
            <button id="btnLeave" class="warn">Salir</button>
          </div>
        </div>

        <div class="controls" style="margin-bottom:10px">
          <button id="btnStartGame" class="success">Iniciar juego</button>
          <button id="btnStartVote" class="primary">Iniciar votación</button>
          <button id="btnEndVote" class="danger">Finalizar Votación</button>
          <button id="btnRestart" class="warn">Reiniciar juego</button>
        </div>

        <div class="list" id="participantsList" aria-live="polite"></div>
      </section>

      <!-- Lado derecho: Estado & Progreso grupal -->
      <section class="card">
        <div class="section-title">
          <h2>Progreso Grupal</h2>
          <span class="subtle">Progreso conjunto del equipo (0–30). Solo el Moderador puede ajustar.</span>
        </div>

        <div class="progress-wrap">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div id="progressLabel" class="hl">0 / 30</div>
            <div id="moderatorNotice" class="subtle"></div>
          </div>
          <div class="progress-bar" aria-label="Progreso grupal">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="prog-ctrls">
            <button id="btnMinus" class="warn">−1</button>
            <button id="btnPlus" class="success">+1</button>
          </div>
          <div class="subtle">Trabajen juntos para llegar a 30 puntos. El moderador decide cómo se ganan/perdían puntos.</div>
        </div>

        <hr style="opacity:.15;margin:16px 0" />

        <div>
          <div class="section-title">
            <h2>Votación</h2>
            <span class="subtle">La votación es anónima. El Moderador no vota ni puede ser votado.</span>
          </div>
          <div class="subtle">Cuando el moderador active la fase de votación, se abrirá una ventana para elegir al “rival más débil”.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal de votación -->
  <div class="modal" id="voteModal" role="dialog" aria-modal="true" aria-labelledby="voteTitle">
    <div class="box">
      <div class="section-title">
        <h2 id="voteTitle">Votación Activa</h2>
        <span class="subtle">Tu voto es anónimo</span>
      </div>
      <div class="subtle">Elige al rival más débil:</div>
      <div class="cand-list" id="candidates"></div>
      <div class="subtle" id="voteHint"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="btnCloseVote" class="warn">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase (Compat) -->
  <!-- Ajusta la versión si lo prefieres -->
  <ttps://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-ript>
  <ttps://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js</script>

  <script>
    // =========================
    // 1) Configura tu Firebase
    // =========================
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_DOMINIO.firebaseapp.com",
      databaseURL: "https://TU_PROYECTO-default-rtdb.firebaseio.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:xxxxxxxxxxxxxxxx"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Una sola sala (puedes parametrizar si quieres múltiples)
    const ROOM_ID = "sala-1";
    const roomRef = db.ref(`rooms/${ROOM_ID}`);
    const participantsRef = roomRef.child("participants");
    const votesRef = roomRef.child("votes");

    // Estado local
    let me = { uid:null, name:"" };
    let room = { phase:"lobby", progress:0, moderatorId:null };
    let participants = {}; // uid -> {name, active, eliminated, joinedAt}
    let myVote = null;

    // Utilidades UI
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const els = {
      connDot: $('#conn-dot'),
      roleChip: $('#roleChip'),
      phaseChip: $('#phaseChip'),
      displayName: $('#displayName'),
      btnJoin: $('#btnJoin'),
      btnLeave: $('#btnLeave'),
      btnStartGame: $('#btnStartGame'),
      btnStartVote: $('#btnStartVote'),
      btnEndVote: $('#btnEndVote'),
      btnRestart: $('#btnRestart'),
      participantsList: $('#participantsList'),
      progressLabel: $('#progressLabel'),
      progressFill: $('#progressFill'),
      moderatorNotice: $('#moderatorNotice'),
      btnPlus: $('#btnPlus'),
      btnMinus: $('#btnMinus'),
      voteModal: $('#voteModal'),
      candidates: $('#candidates'),
      voteHint: $('#voteHint'),
      btnCloseVote: $('#btnCloseVote'),
      toast: $('#toast')
    };

    // Persistir nombre local
    els.displayName.value = localStorage.getItem("rmd_name") || "";

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(()=>els.toast.classList.remove('show'), 2000);
    }

    function isModerator(){ return me.uid && room.moderatorId === me.uid; }
    function iAmActive(){
      const p = participants[me.uid];
      return !!(p && p.active && !p.eliminated);
    }

    function updateChips(){
      els.roleChip.textContent = isModerator() ? "Rol: Moderador" : (iAmActive() ? "Rol: Participante" : "No unido");
      els.phaseChip.textContent = `Fase: ${room.phase}`;
      els.moderatorNotice.textContent = isModerator() ? "Eres moderador: puedes ajustar el progreso." : "Solo el moderador puede ajustar puntos.";
    }

    function renderParticipants(){
      const list = els.participantsList;
      list.innerHTML = "";
      const entries = Object.entries(participants)
        .sort((a,b)=>(a[1].joinedAt||0) - (b[1].joinedAt||0));

      for(const [uid, p] of entries){
        const div = document.createElement('div');
        div.className = 'player';
        const left = document.createElement('div');
        const right = document.createElement('div');
        right.className = 'badges';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = p.name || `Jugador (${uid.slice(0,5)}…)`;
        left.appendChild(name);

        if (room.moderatorId === uid){
          const b = document.createElement('span'); b.className = 'tag mod'; b.textContent = 'MOD';
          right.appendChild(b);
        }
        if (p.eliminated){
          const b = document.createElement('span'); b.className = 'tag out'; b.textContent = 'Fuera';
          right.appendChild(b);
        }else if (p.active){
          const b = document.createElement('span'); b.className = 'tag'; b.textContent = 'Activo';
          right.appendChild(b);
        }else{
          const b = document.createElement('span'); b.className = 'tag'; b.textContent = 'Inactivo';
          right.appendChild(b);
        }

        if (uid === me.uid){
          const b = document.createElement('span'); b.className = 'tag'; b.textContent = 'Tú';
          right.appendChild(b);
        }

        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      }
    }

    function setProgressUI(value){
      const v = Math.max(0, Math.min(30, Number(value)||0));
      els.progressLabel.textContent = `${v} / 30`;
      const pct = `${(v/30)*100}%`;
      els.progressFill.style.setProperty('--v', pct);
    }

    function setPhase(newPhase){
      room.phase = newPhase;
      updateChips();
      // Mostrar modal de votación si aplica
      const canVote = me.uid && !isModerator() && iAmActive();
      if (newPhase === 'voting' && canVote){
        openVoteModal();
      }else{
        closeVoteModal();
      }
      // Botones habilitados/visibles según rol/fase
      const m = isModerator();
      els.btnStartGame.disabled = !m || room.phase!=='lobby';
      els.btnStartVote.disabled = !m || room.phase!=='playing';
      els.btnEndVote.disabled = !m || room.phase!=='voting';
      els.btnRestart.disabled = !m;
    }

    function openVoteModal(){
      buildCandidates();
      els.voteModal.classList.add('show');
    }
    function closeVoteModal(){
      els.voteModal.classList.remove('show');
    }

    function buildCandidates(){
      els.candidates.innerHTML = "";
      // Elegibles: activos, no eliminados, no moderador, no tú
      const eligibles = Object.entries(participants)
        .filter(([uid,p]) => p.active && !p.eliminated && uid !== me.uid && uid !== room.moderatorId);

      if (eligibles.length === 0){
        els.voteHint.textContent = "No hay candidatos elegibles en este momento.";
        return;
      }

      for(const [uid, p] of eligibles){
        const card = document.createElement('div');
        card.className = 'cand';
        const strong = document.createElement('div');
        strong.style.fontWeight = '700';
        strong.textContent = p.name || `Jugador (${uid.slice(0,5)}…)`;
        const small = document.createElement('div');
        small.className = 'subtle';
        small.textContent = 'Votar a esta persona';

        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = myVote === uid ? 'Cambiar mi voto a esta persona' : 'Votar';
        btn.addEventListener('click', ()=>castVote(uid));

        card.appendChild(strong);
        card.appendChild(small);
        card.appendChild(btn);
        els.candidates.appendChild(card);
      }

      els.voteHint.textContent = myVote ? `Tu voto actual: ${(participants[myVote]?.name)||'—'}` : 'Aún no has votado.';
    }

    function castVote(targetUid){
      if (!me.uid || isModerator() || !iAmActive() || room.phase!=='voting') return;
      votesRef.child(me.uid).set(targetUid).then(()=>{
        myVote = targetUid;
        buildCandidates();
        showToast('Voto registrado');
      }).catch(()=>{
        showToast('No se pudo registrar el voto');
      });
    }

    // =========================
    // 2) Lógica Realtime
    // =========================
    // Conexión
    db.ref('.info/connected').on('value', snap=>{
      const ok = !!snap.val();
      els.connDot.style.background = ok ? '#22c55e' : '#ef4444';
    });

    // Estado de sala
    roomRef.child('progress').on('value', s=>{
      const v = Number(s.val()||0);
      room.progress = v;
      setProgressUI(v);
    });
    roomRef.child('phase').on('value', s=>{
      const v = s.val() || 'lobby';
      setPhase(v);
    });
    roomRef.child('moderatorId').on('value', s=>{
      room.moderatorId = s.val() || null;
      updateChips();
      // Ajustar controles de progreso
      const m = isModerator();
      els.btnPlus.disabled = !m;
      els.btnMinus.disabled = !m;
      // Botones de flujo
      els.btnStartGame.disabled = !m || room.phase!=='lobby';
      els.btnStartVote.disabled = !m || room.phase!=='playing';
      els.btnEndVote.disabled = !m || room.phase!=='voting';
      els.btnRestart.disabled = !m;
      renderParticipants();
    });

    // Participantes
    participantsRef.on('value', s=>{
      participants = s.val()||{};
      renderParticipants();
      // Si el moderador actual no es válido, reasignar a otro activo
      ensureModeratorExists();
    });

    // Mis votos
    votesRef.child('.info').off(); // nada
    // Escuchar mi voto para pintar estado
    function watchMyVote(){
      if (!me.uid) return;
      votesRef.child(me.uid).on('value', s=>{
        myVote = s.val() || null;
        if (room.phase === 'voting' && !isModerator()){
          buildCandidates();
        }
      });
    }

    // =========================
    // 3) Auth Anónima
    // =========================
    auth.onAuthStateChanged(async user=>{
      if (!user){
        await auth.signInAnonymously();
        return;
      }
      me.uid = user.uid;
      updateChips();
      watchMyVote();
    });

    // =========================
    // 4) Acciones
    // =========================
    function cleanName(v){
      return (v||'').toString().trim().slice(0,40);
    }

    async function join(){
      const name = cleanName(els.displayName.value);
      if (!name){ showToast('Escribe tu nombre para unirte'); return; }
      if (!me.uid){ showToast('Conectando… intenta de nuevo'); return; }

      localStorage.setItem("rmd_name", name);
      const pRef = participantsRef.child(me.uid);
      await pRef.update({
        name, active:true, eliminated:false, joinedAt: firebase.database.ServerValue.TIMESTAMP
      });
      // Primer moderador: si no hay, me lo asigno
      await roomRef.child('moderatorId').transaction(curr => curr || me.uid);
      // Si la fase estaba "ended", lo regresamos a lobby si no hay juego corriendo
      updateChips();
      showToast('¡Te uniste!');
    }

    async function leave(){
      if (!me.uid) return;
      await participantsRef.child(me.uid).update({ active:false });
      if (room.moderatorId === me.uid){
        await reassignModerator();
      }
      updateChips();
      showToast('Saliste del juego');
    }

    async function startGame(){
      if (!isModerator()) return showToast('Solo el moderador puede iniciar');
      await roomRef.update({ phase:'playing', progress:0 });
      await votesRef.set(null);
      showToast('Juego iniciado');
    }

    async function startVoting(){
      if (!isModerator()) return showToast('Solo el moderador puede iniciar votación');
      await votesRef.set(null);
      await roomRef.update({ phase:'voting' });
      showToast('Votación iniciada');
    }

    async function endVoting(){
      if (!isModerator()) return showToast('Solo el moderador puede finalizar votación');
      const [votesSnap, partsSnap] = await Promise.all([votesRef.get(), participantsRef.get()]);
      const vs = votesSnap.val()||{};
      const ps = partsSnap.val()||{};
      const mod = room.moderatorId;

      // Contar votos solo a elegibles
      const counts = {};
      for(const [voter, target] of Object.entries(vs)){
        const tp = ps[target];
        if (!tp) continue;
        const eligible = tp.active && !tp.eliminated && target !== mod;
        if (!eligible) continue;
        counts[target] = (counts[target]||0) + 1;
      }

      let eliminatedUid = null;
      let maxVotes = -1;
      for(const [uid,count] of Object.entries(counts)){
        if (count > maxVotes){ maxVotes = count; eliminatedUid = uid; }
        else if (count === maxVotes && Math.random() < 0.5){ // desempate aleatorio simple
          eliminatedUid = uid;
        }
      }

      const updates = { phase:'playing' };
      if (eliminatedUid){
        updates[`participants/${eliminatedUid}/eliminated`] = true;
        updates[`participants/${eliminatedUid}/active`] = false;
      }
      updates['votes'] = null;

      await roomRef.update(updates);
      showToast(eliminatedUid ? `Eliminado: ${ps[eliminatedUid]?.name || eliminatedUid}` : 'Sin eliminados');
    }

    async function restartGame(){
      if (!isModerator()) return showToast('Solo el moderador puede reiniciar');
      const snap = await participantsRef.get();
      const ps = snap.val()||{};
      const updates = {};
      for(const [uid, p] of Object.entries(ps)){
        updates[`participants/${uid}/eliminated`] = false;
        // Requediste: re-activar a quienes estaban fuera
        updates[`participants/${uid}/active`] = true;
      }
      updates['progress'] = 0;
      updates['phase'] = 'lobby';
      updates['votes'] = null;
      await roomRef.update(updates);
      showToast('Juego reiniciado: todos reactivados');
    }

    async function incProgress(delta){
      if (!isModerator()) return showToast('Solo el moderador puede ajustar');
      await roomRef.child('progress').transaction(curr=>{
        const v = Math.max(0, Math.min(30, Number(curr||0) + delta));
        return v;
      });
    }

    // Moderación: garantizar que siempre exista moderador cuando hay participantes activos
    async function ensureModeratorExists(){
      const mod = room.moderatorId;
      if (mod && participants[mod] && participants[mod].active) return;
      await reassignModerator();
    }

    async function reassignModerator(){
      const candidates = Object.entries(participants)
        .filter(([uid,p])=>p.active && !p.eliminated)
        .sort((a,b)=>(a[1].joinedAt||0) - (b[1].joinedAt||0));
      const next = candidates[0]?.[0] || null;
      await roomRef.child('moderatorId').set(next);
      if (next){
        showToast(`Nuevo moderador: ${participants[next]?.name || next}`);
      }else{
        showToast('Sin moderador (no hay participantes activos)');
      }
    }

    // =========================
    // 5) Eventos UI
    // =========================
    els.btnJoin.addEventListener('click', join);
    els.btnLeave.addEventListener('click', leave);
    els.btnStartGame.addEventListener('click', startGame);
    els.btnStartVote.addEventListener('click', startVoting);
    els.btnEndVote.addEventListener('click', endVoting);
    els.btnRestart.addEventListener('click', restartGame);
    els.btnPlus.addEventListener('click', ()=>incProgress(+1));
    els.btnMinus.addEventListener('click', ()=>incProgress(-1));
    els.btnCloseVote.addEventListener('click', closeVoteModal);

    // Estado inicial de botones
    function refreshButtons(){
      const joined = iAmActive();
      els.btnJoin.disabled = joined;
      els.btnLeave.disabled = !joined && !isModerator() && !participants[me.uid];

      const m = isModerator();
      els.btnPlus.disabled = !m;
      els.btnMinus.disabled = !m;
      els.btnStartGame.disabled = !m || room.phase!=='lobby';
      els.btnStartVote.disabled = !m || room.phase!=='playing';
      els.btnEndVote.disabled = !m || room.phase!=='voting';
      els.btnRestart.disabled = !m;
    }
    setInterval(refreshButtons, 500); // simple polling para mantener coherencia visual
  </script>

  <!--
    Reglas sugeridas de seguridad (Realtime Database):
    Ajusta según tus necesidades (NO se aplican automáticamente desde aquí).
    {
      "rules": {
        ".read": "auth != null",
        ".write": "auth != null",
        "rooms": {
          "$room": {
            "progress": { ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 30" },
            "moderatorId": { ".validate": "newData.isString()" },
            "phase": { ".validate": "newData.val() in ['lobby','playing','voting','ended']" }
          }
        }
      }
    }
  -->
</body>
</html>
